<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì°©í•œí•œìš° ì£¼ë¬¸ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #fdfdfd;
    }
.container {
  max-width: 1700px;
  width: 100%;
  margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
}

h1 {
      text-align: center;
      margin-bottom: 20px;
    }

#searchInput {
  display: block;
  margin: 0 auto 20px auto; /* ê²€ìƒ‰ì°½ ê°€ìš´ë° */
  width: 300px;
  padding: 8px;
  font-size: 16px;
}

  #orderContainer {
  text-align: left; /* ì£¼ë¬¸ í…Œì´ë¸” ì™¼ìª½ ì •ë ¬ */
}
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px 8px;
      border: 1px solid #ccc;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background-color: #f2f2f2;
    }

    .paid {
      color: green;
      font-weight: bold;
    }
    .unpaid {
      color: red;
      font-weight: bold;
    }
    button {
      padding: 6px 10px;
      font-size: 14px;
      margin: 2px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.delete {
      background-color: #f44336;
    }
    button:hover {
      opacity: 0.8;
    }
    .extra-row {
      background-color: #fcfcfc;
      text-align: left;
      padding-left: 20px;
    }

    .canceled {
      color: gray;
      font-weight: bold;
  }

  </style>
</head>
<body>
<div class="container">

  <h1 class="center">ğŸ® ì°©í•œí•œìš° ì£¼ë¬¸ ê´€ë¦¬ í˜ì´ì§€ ğŸ·</h1>

  <div style="text-align: center; margin-bottom: 20px;">
    <input type="text" id="searchInput" placeholder="ì´ë¦„, ì—°ë½ì²˜, ì£¼ì†Œ ê²€ìƒ‰" style="width: 300px; padding: 8px; font-size: 16px;">
  </div>

  <div id="orderContainer"></div>

  <div style="text-align: center; margin-top: 20px;">
    <button onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ë¡œ ì €ì¥í•˜ê¸°</button>
  </div>

</div>

<script>
// ë¬´ê²Œ í‘œì‹œ í¬ë§·
function formatWeight(weight, type) {
  if (type === 'marinated') return `${weight.toLocaleString()}ê°œ`;
  return `${weight.toLocaleString()}g`;
}

// ì£¼ë¬¸ ê°€ì ¸ì˜¤ê¸°
async function fetchOrders() {
  try {
    const res = await fetch('/get-orders');
    const orders = await res.json();
    const grouped = {};
    const keyword = document.getElementById('searchInput')?.value?.toLowerCase() || '';

    const container = document.getElementById('orderContainer');
    container.innerHTML = '';

    orders.filter(order => {
      const combined = `${order.name} ${order.contact} ${order.address}`.toLowerCase();
      return combined.includes(keyword);
    }).forEach(order => {
      const date = order.ë°°ì†¡ì¼ì || 'ë¶„ë¥˜ë¶ˆê°€';
      if (!grouped[date]) grouped[date] = [];
      grouped[date].push(order);
    });

    Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
      const section = document.createElement('div');
      const sectionId = `section-${date}`;

      section.innerHTML = `
        <div onclick="toggleSection('${sectionId}')" 
         style="display: inline-block; padding: 8px 16px; background-color: #f7f7f7; border: 1px solid #ccc; border-radius: 8px; box-shadow: 1px 1px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; margin-bottom: 10px;">
          <span style="font-size: 20px; font-weight: bold; color: #333;">ğŸ“… ${date}</span>
        </div>
        <table id="${sectionId}" style="display: block;">
          <thead>
            <tr>
              <th>ì£¼ë¬¸ì‹œê°„</th>
              <th>ì´ë¦„</th>
              <th>ì—°ë½ì²˜</th>
              <th>ì£¼ì†Œ</th>
              <th>ê³µë™í˜„ê´€</th>
              <th>ì£¼ë¬¸ìƒí’ˆ</th>
              <th>ê²°ì œë°©ë²•</th>
              <th>ì…ê¸ˆìëª…</th>        
              <th>í˜„ê¸ˆì˜ìˆ˜ì¦ë²ˆí˜¸</th>
              <th>ì´ ê¸ˆì•¡</th>
              <th>ê²°ì œì—¬ë¶€</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${grouped[date].map(order => {
              const items = order.items.map(item => `${item.meat} ${formatWeight(item.weight, item.type)}`).join(', ');
              const isCancelRequested = order.cancelRequested === true;
              const isPaid = order.isPaid === true;
              const isCanceled = order.isCanceled === true;
              return `
                <tr data-order-id="${order._id}">
                  <td>${order.timestamp || '-'}</td>
                  <td>${order.name || '-'}</td>
                  <td>${order.contact || '-'}</td>
                  <td>${order.address || '-'}</td>
                  <td>${order.doorcode || '-'}</td>
                  <td>${items}</td>
                  <td>${order.paymentMethod === 'account' ? 'ê³„ì¢Œì´ì²´' : 'ì¹´ë“œê²°ì œ'}</td>
                  <td>${order.depositorName || '-'}</td>
                  <td>${order.cashReceipt || '-'}</td>
                  <td>${order.totalAmount || '-'}</td>
                  <td class="${order.isCanceled ? 'canceled' : (order.isPaid ? 'paid' : 'unpaid')}">
                    ${order.isCanceled ? 'ì·¨ì†Œë¨' : (order.isPaid ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ')}</td>
                  <td>
                    ${!order.isPaid ? `<button onclick="markAsPaid('${order._id}')">ê²°ì œì™„ë£Œ</button>` : ''}
                    ${isCancelRequested && isPaid ? `<button onclick="cancelApproved('${order._id}')">ì·¨ì†ŒìŠ¹ì¸</button>` : ''}
                    <button class="delete" onclick="deleteOrder('${order._id}')">ì‚­ì œ</button>
                  </td>
                </tr>
                ${order.requestMessage ? `<tr data-extra-for="${order._id}"><td colspan="12" class="extra-row">ğŸ“ ìš”ì²­ì‚¬í•­: ${order.requestMessage}</td></tr>` : ''}
                ${order.deliveryRequest ? `<tr data-extra-for="${order._id}"><td colspan="12" class="extra-row">ğŸšš ë°°ì†¡ ìš”ì²­ì‚¬í•­: ${order.deliveryRequest}</td></tr>` : ''}
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      container.appendChild(section);
    });
  } catch (error) {
    console.error('ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
  }
}

// ì„¹ì…˜ ì ‘ê¸°
function toggleSection(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// ê²°ì œ ì™„ë£Œ ì²˜ë¦¬
async function markAsPaid(orderId) {
  const response = await fetch(`/mark-paid/${orderId}`, { method: 'POST' });
  if (response.ok) {
    alert('ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!');

    // ğŸ”¥ ì§ì ‘ ê²°ì œìƒíƒœë§Œ ë°”ê¿”ì£¼ì
    const tr = document.querySelector(`tr[data-order-id="${orderId}"]`);
    if (tr) {
      const paymentCell = tr.querySelector('td:nth-child(11)');  // 11ë²ˆì§¸ ì¹¸ì´ ê²°ì œì—¬ë¶€
      paymentCell.className = 'paid';
      paymentCell.textContent = 'ì™„ë£Œ';

      const buttonContainer = tr.querySelector('td:nth-child(12)');
      buttonContainer.innerHTML = `<button class="delete" onclick="deleteOrder('${orderId}')">ì‚­ì œ</button>`;
    }
  } else {
    alert('ì²˜ë¦¬ ì‹¤íŒ¨');
  }
}


// ì£¼ë¬¸ ì‚­ì œ
async function deleteOrder(orderId) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  const res = await fetch(`/delete-order/${orderId}`, { method: 'POST' });
  const data = await res.json();
  if (data.success) {
    alert('ì‚­ì œ ì™„ë£Œ!');
    document.querySelector(`[data-order-id="${orderId}"]`)?.remove();
    document.querySelectorAll(`[data-extra-for="${orderId}"]`)?.forEach(el => el.remove());
  } else {
    alert('ì‚­ì œ ì‹¤íŒ¨!');
  }
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadExcel() {
  window.location.href = '/download-orders';
}


async function cancelApproved(orderId) {
  if (!confirm("PGì‚¬ì— ê²°ì œ ì·¨ì†Œê¹Œì§€ ì²˜ë¦¬í• ê¹Œìš”?")) return;

  const res = await fetch('/cancel-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order_id: orderId })
  });

  let data;
  try {
    data = await res.json();
  } catch (err) {
    const rawText = await res.text();
    console.error("ğŸ”¥ ì„œë²„ ì—ëŸ¬ ì‘ë‹µ ì›ë¬¸:", rawText);
    alert("âŒ ì„œë²„ ì—ëŸ¬ ì‘ë‹µ:\n\n" + rawText);
    return;
  }

  if (data.success) {
    alert(data.message);
    fetchOrders();
  } else {
    alert('âŒ ì·¨ì†Œ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
  }
}

// âœ… window.onload ì •ë¦¬
window.onload = function () {
  fetchOrders();
  document.getElementById('searchInput').addEventListener('input', fetchOrders);
};</script>
</body>
</html>
